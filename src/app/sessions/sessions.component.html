<!--
  Author: Edgar Butwilowski
  Copyright (c) Fachstelle Geoinformation Winterthur. All rights reserved.

  Sessions view:
  - Top grid: list of sessions (master list)
  - Below: three independent child grids that reflect the currently selected session:
      1) Projects (isRoadworkProject === true)
      2) Present users (isRoadworkProject === false AND isPresent === true)
      3) Distribution list users (isRoadworkProject === false AND isDistributionList === true)
-->

<!-- Hidden container used for report generation (HTML â†’ DOCX/PDF). -->
<div #reportContainer style="position: fixed; left: -9999px; top: 0; visibility: hidden;"></div>


<div style="margin:0;margin-left: 2em;margin-right: 2em;" >
  <div style="margin-bottom: 1em;">
    <h2>
      SKS Sitzungen ({{ sessionsData.length }})      
      <label class="quick-filter" style="display:inline-flex; gap:.5em; align-items:center; margin-left:20px;margin-right:20px">        
        <input
          type="text"
          id="input-quick-filter"
          placeholder="Suchen..."
          (input)="onQuickFilterChanged()"
          style="padding:.35em .5em; width: 16rem;"
        />
      </label>

      <button mat-button 
            *ngIf="isRoleAdministrator"
            (click)="openNewSessionDialog()"
            [disabled]="isDataLoading"
            style="margin: 1em;background-color: rgb(236,236,234);">
            <mat-icon aria-label="Icon zeigt Plus">add</mat-icon>&nbsp;NEUE SITZUNG
      </button>

      <button mat-button (click)="saveDetails(); savePeopleAsCsv();"
              [disabled]="!selectedNode?.data?.sksNo || ( !detailsForm.dirty && !peopleDirty ) || detailsForm.invalid"
              style="margin: 1em;background-color: rgb(236,236,234);">
              <mat-icon aria-label="Icon zeigt Diskette">save</mat-icon>&nbsp;SPEICHERN
      </button>
          
    </h2> 
      
  </div>
 
  <!-- Loading indicator overlay -->
  <mat-progress-bar *ngIf="isDataLoading" mode="indeterminate" color="primary"></mat-progress-bar>
  
  <div class="grid-overlay" *ngIf="isDataLoading"></div>

  <!-- Master grid: list of sessions -->  
  <ag-grid-angular
    #sessionsGrid
    class="ag-theme-alpine"
    rowSelection="single"
    [rowData]="sessionsData"
    [columnDefs]="sessionsColDefs"
    [defaultColDef]="defaultColDef"    
    [rowHeight]="28"
    [headerHeight]="28"
    [includeHiddenColumnsInQuickFilter]="true" 
    [attr.inert]="isDataLoading ? '' : null"
    [localeText]="localeText"
    (gridReady)="onSessionsGridReady($event)"
    (selectionChanged)="onSessionSelectionChanged()"        
    style="width: 100%; height: 20vh;"    
  >
  </ag-grid-angular>

  
  <!-- Child grids container -->
  <div style="display: grid; grid-template-columns: 50fr 50fr; gap: 3rem;">
    <h3 style="grid-column: span 2; margin-bottom: .5rem;">      
      <ng-container *ngIf="selectedSession as s">{{ s.sessionName }}</ng-container>
    </h3>        
      
    <form [formGroup]="detailsForm" class="details-form">

      <!-- Planned Date + Session Type -->
      <!-- Row 1: 50/50 (6 cols + 6 cols) -->
      <div style="margin-top: 10px;grid-column: 1 / -1; display:grid; grid-template-columns: repeat(12, 1fr); gap:16px;">

        <!-- Planned Date -->
        <mat-form-field appearance="outline" style="grid-column: span 6; width: 100%;">
          <mat-label><label style="font-size:18px; font-weight:bold;color:black" for="plannedDateInput">Geplantes Datum</label></mat-label>                                        
          <input
            matInput
            #plannedDateInput
            [matDatepicker]="picker"
            formControlName="plannedDate"
            placeholder="YYYY-MM-DD"
            autocomplete="off"
            inputmode="none"
            readonly
            appPreventTyping
          />
          <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
          <mat-datepicker #picker></mat-datepicker>
          <mat-error *ngIf="detailsForm.get('plannedDate')?.hasError('required')">
            Pflichtfeld
          </mat-error>
        </mat-form-field>

        <!-- Session Type -->
        <mat-form-field appearance="outline" style="grid-column: span 6; width: 100%;">
          <mat-label>
          <label style="font-size:18px;font-weight: bold; color:black" for="reportTypeInput">
            Berichtsstatus
          </label>
        </mat-label>

        <mat-select #reportTypeInput formControlName="reportType">
          <mat-option *ngFor="let option of SESSION_TYPE_OPTIONS" [value]="option">
            {{ option }}
          </mat-option>
        </mat-select>

        <mat-error *ngIf="detailsForm.get('reportType')?.hasError('required')">
          Pflichtfeld
        </mat-error>
        </mat-form-field>
      </div>

        <!-- Acceptance -->
        <div class="field"
             [ngStyle]="SESSION_TYPE_TO_DB[detailsForm.get('reportType')?.value] === 'PRE_PROTOCOL' ? {'pointer-events':'none','opacity':'0.6'} : null">
          <h5  style="margin: .25rem;">1. Abnahme SKS-Protokoll</h5>
          <textarea
            id="acceptance1"
            formControlName="acceptance1"
            [readonly]="SESSION_TYPE_TO_DB[detailsForm.get('reportType')?.value] === 'PRE_PROTOCOL'"
            [disabled]="SESSION_TYPE_TO_DB[detailsForm.get('reportType')?.value] === 'PRE_PROTOCOL'"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."
          ></textarea>
          <small>{{ detailsForm.get('acceptance1')?.value?.length || 0 }} / 10000</small>
        </div>

        <!-- Attachments -->
        <div class="field">
          <h5 style="margin: .25rem;">Beilage</h5>
          <textarea
            id="attachments"
            formControlName="attachments"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."            
          ></textarea>
          <small>{{ detailsForm.get('attachments')?.value?.length || 0 }} / 10000</small>
        </div>

        <!-- Misc Items -->
        <div class="field">
          <h5  style="margin: .25rem;">Verschiedenes</h5>
          <textarea
            id="miscItems"
            formControlName="miscItems"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."
          ></textarea>
          <small>{{ detailsForm.get('miscItems')?.value?.length || 0 }} / 10000</small>
        </div>

    </form>

    <!-- Projects, Present and distribution users -->
    <div>            
      <h5 style="margin: .25rem;">Teilnehmerliste ({{ getPresentListCount(presentUserRows) }})</h5>
      <ag-grid-angular
        #presentGrid
        class="ag-theme-alpine"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="presentUserRows"
        [columnDefs]="peopleColDefs"
        [defaultColDef]="childDefaultColDef"
        [localeText]="localeText"
        style="width: 100%; height: 15vh;"        
        (cellValueChanged)="peopleDirty=true"
      >
      </ag-grid-angular>

      <h5 style="margin: .25rem;margin-top: 1rem">E-Mail-Verteiler ({{ getDistributionListCount(distributionUserRows) }})</h5>
      <ag-grid-angular
        #distributionGrid        
        class="ag-theme-alpine"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="distributionUserRows"
        [columnDefs]="distributionColDefs"
        [defaultColDef]="childDefaultColDef"
        [localeText]="localeText"
        style="width: 100%; height: 15vh;"     
        (cellValueChanged)="peopleDirty=true"
      >
      </ag-grid-angular>

      <h5 style="margin: .25rem;margin-top: 1rem;">Bauvorhaben ({{ projectRows.length }})</h5>
      <ag-grid-angular
        #projectGrid
        class="ag-theme-alpine"
        rowSelection="single"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="projectRows"
        [columnDefs]="projectsColDefs"
        [defaultColDef]="childDefaultColDef"        
        [localeText]="localeText"
        style="width: 100%; height:17vh;"                 
        (selectionChanged)="onProjectSelectionChanged()"
        (firstDataRendered)="onProjectFirstDataRendered($event)"
      >
      </ag-grid-angular>
    </div>
        

  </div>
</div>
