<!--
  Author: Edgar Butwilowski
  Copyright (c) Fachstelle Geoinformation Winterthur. All rights reserved.

  Sessions view:
  - Top grid: list of sessions (master list)
  - Below: three independent child grids that reflect the currently selected session:
      1) Projects (isRoadworkProject === true)
      2) Present users (isRoadworkProject === false AND isPresent === true)
      3) Distribution list users (isRoadworkProject === false AND isDistributionList === true)
-->

<!-- Hidden container used for report generation (HTML â†’ DOCX/PDF). -->
<div #reportContainer style="position: fixed; left: -9999px; top: 0; visibility: hidden;"></div>


<div style="margin:0;margin-left: 2em;margin-right: 2em;" >
  <div style="margin-bottom: 1em;">
    <h3>
      SKS Sitzungen ({{ sessionsData.length }})      
      <label class="quick-filter" style="display:inline-flex; gap:.5em; align-items:center;">        
        <input
          type="text"
          id="input-quick-filter"
          placeholder="Suchen..."
          (input)="onQuickFilterChanged()"
          style="padding:.35em .5em; width: 16rem;"
        />
      </label>

      <button mat-button 
            (click)="openNewSessionDialog()"
            [disabled]="isDataLoading"
            style="margin: 1em;background-color: rgb(236,236,234);">
            <mat-icon aria-label="Icon zeigt Plus">add</mat-icon>&nbsp;NEUE SITZUNG
      </button>

      <button mat-button (click)="saveDetails(); savePeopleAsCsv();"
              [disabled]="!selectedNode?.data?.sksNo || ( !detailsForm.dirty && !peopleDirty ) || detailsForm.invalid"
              style="margin: 1em;background-color: rgb(236,236,234);">
              <mat-icon aria-label="Icon zeigt Diskette">save</mat-icon>&nbsp;SPEICHERN
      </button>
          
    </h3> 
      
  </div>
 
  <!-- Loading indicator overlay -->
  <mat-progress-bar *ngIf="isDataLoading" mode="indeterminate" color="primary"></mat-progress-bar>
  
  <div class="grid-overlay" *ngIf="isDataLoading"></div>

  <!-- Master grid: list of sessions -->  
  <ag-grid-angular
    #sessionsGrid
    class="ag-theme-alpine"
    rowSelection="single"
    [rowData]="sessionsData"
    [columnDefs]="sessionsColDefs"
    [defaultColDef]="defaultColDef"    
    [rowHeight]="28"
    [headerHeight]="28"
    [includeHiddenColumnsInQuickFilter]="true" 
    [attr.inert]="isDataLoading ? '' : null"
    [localeText]="localeText"
    (gridReady)="onSessionsGridReady($event)"
    (selectionChanged)="onSessionSelectionChanged()"        
    style="width: 100%; height: 20vh;"    
  >
  </ag-grid-angular>

  
  <!-- Child grids container -->
  <div style="display: grid; grid-template-columns: 60fr 40fr; gap: 3rem;">
    <h3 style="grid-column: span 2; margin-bottom: .5rem;">      
      <ng-container *ngIf="selectedSession as s">{{ s.sessionName }}</ng-container>
    </h3>        
      
    <form [formGroup]="detailsForm" class="details-form">

        <!-- ðŸ”¹ Planned Date + Session Type obok siebie -->
        <div class="form-row">
          <!-- Planned Date -->
          <mat-form-field appearance="outline" >
            <mat-label>Geplantes Datum</mat-label>
            <input
              matInput
              [matDatepicker]="picker"
              formControlName="plannedDate"
              placeholder="YYYY-MM-DD"
            />
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-datepicker #picker></mat-datepicker>
            <mat-error *ngIf="detailsForm.get('plannedDate')?.hasError('required')">
              Pflichtfeld
            </mat-error>
          </mat-form-field>

          <!-- Session Type -->
          <mat-form-field appearance="outline" >
            <mat-label>Sitzungstyp</mat-label>
            <mat-select formControlName="sessionType">
              <mat-option value="Vor-Protokol SKS">Vor-Protokol SKS</mat-option>
              <mat-option value="Protokol SKS">Protokol SKS</mat-option>
            </mat-select>
            <mat-error *ngIf="detailsForm.get('sessionType')?.hasError('required')">
              Pflichtfeld
            </mat-error>
          </mat-form-field>
        </div>

        <!-- ðŸ”¹ Acceptance -->
        <div class="field">
          <label for="acceptance1">1. Abnahme SKS-Protokoll</label>
          <textarea
            id="acceptance1"
            formControlName="acceptance1"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."
          ></textarea>
          <small>{{ detailsForm.get('acceptance1')?.value?.length || 0 }} / 10000</small>
        </div>

        <!-- ðŸ”¹ Attachments -->
        <div class="field">
          <label for="attachments">Beilage</label>
          <textarea
            id="attachments"
            formControlName="attachments"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."
          ></textarea>
          <small>{{ detailsForm.get('attachments')?.value?.length || 0 }} / 10000</small>
        </div>

        <!-- ðŸ”¹ Misc Items -->
        <div class="field">
          <label for="miscItems">Verschiedenes</label>
          <textarea
            id="miscItems"
            formControlName="miscItems"
            maxlength="10000"
            rows="9"
            placeholder="Bitte Text hiereingeben..."
          ></textarea>
          <small>{{ detailsForm.get('miscItems')?.value?.length || 0 }} / 10000</small>
        </div>

    </form>

    <!-- Projects, Present and distribution users -->
    <div>      
      <h4 style="margin: .25rem;">Teilnehmerliste ({{ getPresentListCount(presentUserRows) }})</h4>
      <ag-grid-angular
        #presentGrid
        class="ag-theme-alpine"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="presentUserRows"
        [columnDefs]="peopleColDefs"
        [defaultColDef]="childDefaultColDef"
        [localeText]="localeText"
        style="width: 100%; height: 15vh;"        
        (cellValueChanged)="peopleDirty=true"
      >
      </ag-grid-angular>

      <h4 style="margin: .25rem;margin-top: 1rem">E-Mail-Verteiler ({{ getDistributionListCount(distributionUserRows) }})</h4>
      <ag-grid-angular
        #distributionGrid        
        class="ag-theme-alpine"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="distributionUserRows"
        [columnDefs]="distributionColDefs"
        [defaultColDef]="childDefaultColDef"
        [localeText]="localeText"
        style="width: 100%; height: 15vh;"     
        (cellValueChanged)="peopleDirty=true"
      >
      </ag-grid-angular>

      <h4 style="margin: .25rem;margin-top: 1rem;">Bauvorhaben ({{ projectRows.length }})</h4>
      <ag-grid-angular
        #projectGrid
        class="ag-theme-alpine"
        [rowHeight]="28"
        [headerHeight]="28"
        [rowData]="projectRows"
        [columnDefs]="projectsColDefs"
        [defaultColDef]="childDefaultColDef"        
        [localeText]="localeText"
        style="width: 100%; height:15vh;"        
      >
      </ag-grid-angular>
    </div>
        

  </div>
</div>
